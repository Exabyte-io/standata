{"_id":"1bb75a6a-4c8c-5336-a24c-1963e83825bc","name":"Extract Bands Near Fermi","application":{"name":"python"},"properties":[],"model":{"type":"unknown","subtype":"unknown","method":{"type":"unknown","subtype":"unknown","data":{}}},"units":[{"type":"execution","name":"extract_bands_fermi","head":true,"results":[],"monitors":[{"name":"standard_output"}],"flowchartId":"extract-band-fermi","preProcessors":[],"postProcessors":[],"application":{"name":"python","shortName":"py","summary":"Python Script","build":"GNU","isDefault":true,"version":"3.10.13","schemaVersion":"2022.8.16"},"executable":{"isDefault":true,"monitors":["standard_output"],"name":"python","schemaVersion":"2022.8.16"},"flavor":{"applicationName":"python","executableName":"python","input":[{"name":"extract_bands_fermi.py"},{"name":"requirements.txt","templateName":"requirements_empty.txt"}],"monitors":["standard_output"],"name":"extract_bands_fermi","schemaVersion":"2022.8.16","isDefault":false},"status":"idle","statusTrack":[],"tags":[],"input":[{"applicationName":"python","content":"# ---------------------------------------------------------------- #\n# Extract band indices near Fermi energy from pw_scf STDOUT        #\n# This script expects fermi_energy and STDOUT from pw_scf          #\n# ---------------------------------------------------------------- #\nimport json\nimport re\n\n# Data From Context\n# -----------------\n# fermi_energy: float (in eV)\n# STDOUT: string from pw_scf execution\n\n{% raw %}fermi_energy_value = {{ fermi_energy }}{% endraw %}\n{% raw %}stdout_content = \"\"\"{{ STDOUT }}\"\"\"{% endraw %}\n\n# Parse band energies from STDOUT\n# Looking for pattern like:\n#      k = 0.0000 0.0000 0.0000 (  9810 PWs)   bands (ev):\n#   -61.6149 -35.8126 -35.8119 -35.7732 -35.7725 -35.6075 -35.6068\n\n# Find the first k-point (Gamma point) - bands can span multiple lines\nk_pattern = r'k\\s*=\\s*0\\.0000\\s+0\\.0000\\s+0\\.0000.*?bands\\s*\\(ev\\):\\s*([\\s\\S]+?)(?:\\n\\s*\\n|\\n\\s*k\\s*=)'\nmatch = re.search(k_pattern, stdout_content, re.DOTALL)\n\nif not match:\n    # Fallback: find ANY k-point bands section\n    k_pattern = r'bands\\s*\\(ev\\):\\s*([\\s\\S]+?)(?:\\n\\s*\\n|\\n\\s*k\\s*=|\\n\\s*the\\s+Fermi)'\n    match = re.search(k_pattern, stdout_content, re.DOTALL)\n\nif match:\n    # Extract all band energies\n    band_energies_str = match.group(1)\n    band_energies = [float(x) for x in band_energies_str.split()]\n    \n    # Find bands near Fermi energy (1-based indices as QE expects)\n    valence_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e <= fermi_energy_value]\n    conduction_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e > fermi_energy_value]\n    \n    if valence_bands:\n        valence_index, valence_energy = max(valence_bands, key=lambda x: x[1])\n    else:\n        valence_index = 1\n        valence_energy = band_energies[0] if band_energies else 0.0\n    \n    if conduction_bands:\n        conduction_index, conduction_energy = min(conduction_bands, key=lambda x: x[1])\n    else:\n        conduction_index = len(band_energies)\n        conduction_energy = band_energies[-1] if band_energies else 0.0\n    \n    result = {\n        \"band_below_fermi\": valence_index,\n        \"band_above_fermi\": conduction_index,\n        \"fermi_energy\": fermi_energy_value,\n        \"valence_energy\": valence_energy,\n        \"conduction_energy\": conduction_energy,\n        \"total_bands\": len(band_energies)\n    }\nelse:\n    # If parsing fails, provide a default (usually the HOMO is around half of the bands)\n    result = {\n        \"band_below_fermi\": 4,\n        \"band_above_fermi\": 5,\n        \"fermi_energy\": fermi_energy_value,\n        \"error\": \"Could not parse band energies from STDOUT\"\n    }\n\n# Print to STDOUT for subsequent assignment unit\nprint(json.dumps(result, indent=4))\n","contextProviders":[],"executableName":"python","name":"extract_bands_fermi.py","rendered":"# ---------------------------------------------------------------- #\n# Extract band indices near Fermi energy from pw_scf STDOUT        #\n# This script expects fermi_energy and STDOUT from pw_scf          #\n# ---------------------------------------------------------------- #\nimport json\nimport re\n\n# Data From Context\n# -----------------\n# fermi_energy: float (in eV)\n# STDOUT: string from pw_scf execution\n\nfermi_energy_value = {{ fermi_energy }}\nstdout_content = \"\"\"{{ STDOUT }}\"\"\"\n\n# Parse band energies from STDOUT\n# Looking for pattern like:\n#      k = 0.0000 0.0000 0.0000 (  9810 PWs)   bands (ev):\n#   -61.6149 -35.8126 -35.8119 -35.7732 -35.7725 -35.6075 -35.6068\n\n# Find the first k-point (Gamma point) - bands can span multiple lines\nk_pattern = r'k\\s*=\\s*0\\.0000\\s+0\\.0000\\s+0\\.0000.*?bands\\s*\\(ev\\):\\s*([\\s\\S]+?)(?:\\n\\s*\\n|\\n\\s*k\\s*=)'\nmatch = re.search(k_pattern, stdout_content, re.DOTALL)\n\nif not match:\n    # Fallback: find ANY k-point bands section\n    k_pattern = r'bands\\s*\\(ev\\):\\s*([\\s\\S]+?)(?:\\n\\s*\\n|\\n\\s*k\\s*=|\\n\\s*the\\s+Fermi)'\n    match = re.search(k_pattern, stdout_content, re.DOTALL)\n\nif match:\n    # Extract all band energies\n    band_energies_str = match.group(1)\n    band_energies = [float(x) for x in band_energies_str.split()]\n    \n    # Find bands near Fermi energy (1-based indices as QE expects)\n    valence_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e <= fermi_energy_value]\n    conduction_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e > fermi_energy_value]\n    \n    if valence_bands:\n        valence_index, valence_energy = max(valence_bands, key=lambda x: x[1])\n    else:\n        valence_index = 1\n        valence_energy = band_energies[0] if band_energies else 0.0\n    \n    if conduction_bands:\n        conduction_index, conduction_energy = min(conduction_bands, key=lambda x: x[1])\n    else:\n        conduction_index = len(band_energies)\n        conduction_energy = band_energies[-1] if band_energies else 0.0\n    \n    result = {\n        \"band_below_fermi\": valence_index,\n        \"band_above_fermi\": conduction_index,\n        \"fermi_energy\": fermi_energy_value,\n        \"valence_energy\": valence_energy,\n        \"conduction_energy\": conduction_energy,\n        \"total_bands\": len(band_energies)\n    }\nelse:\n    # If parsing fails, provide a default (usually the HOMO is around half of the bands)\n    result = {\n        \"band_below_fermi\": 4,\n        \"band_above_fermi\": 5,\n        \"fermi_energy\": fermi_energy_value,\n        \"error\": \"Could not parse band energies from STDOUT\"\n    }\n\n# Print to STDOUT for subsequent assignment unit\nprint(json.dumps(result, indent=4))\n","schemaVersion":"2022.8.16"},{"applicationName":"python","content":"# ------------------------------------------------------------------ #\n#                                                                    #\n#  Example Python package requirements for the Mat3ra platform       #\n#                                                                    #\n#  Will be used as follows:                                          #\n#                                                                    #\n#    1. A runtime directory for this calculation is created          #\n#    2. This list is used to populate a Python virtual environment   #\n#    3. The virtual environment is activated                         #\n#    4. The Python process running the script included within this   #\n#       job is started                                               #\n#                                                                    #\n#  For more information visit:                                       #\n#   - https://pip.pypa.io/en/stable/reference/pip_install            #\n#   - https://virtualenv.pypa.io/en/stable/                          #\n#                                                                    #\n#  Please add any packages required for this unit below following    #\n#  the requirements.txt specification:                               #\n#  https://pip.pypa.io/en/stable/reference/requirements-file-format/ #\n# ------------------------------------------------------------------ #\n","contextProviders":[],"executableName":"python","name":"requirements.txt","rendered":"# ------------------------------------------------------------------ #\n#                                                                    #\n#  Example Python package requirements for the Mat3ra platform       #\n#                                                                    #\n#  Will be used as follows:                                          #\n#                                                                    #\n#    1. A runtime directory for this calculation is created          #\n#    2. This list is used to populate a Python virtual environment   #\n#    3. The virtual environment is activated                         #\n#    4. The Python process running the script included within this   #\n#       job is started                                               #\n#                                                                    #\n#  For more information visit:                                       #\n#   - https://pip.pypa.io/en/stable/reference/pip_install            #\n#   - https://virtualenv.pypa.io/en/stable/                          #\n#                                                                    #\n#  Please add any packages required for this unit below following    #\n#  the requirements.txt specification:                               #\n#  https://pip.pypa.io/en/stable/reference/requirements-file-format/ #\n# ------------------------------------------------------------------ #\n","schemaVersion":"2022.8.16"}],"next":"f9b3f66b-6659-581d-8791-7153c195214f"},{"name":"Store Band Number","type":"assignment","operand":"KBAND_VALUE","value":"json.loads(STDOUT)['band_below_fermi']","input":[{"name":"STDOUT","scope":"extract-band-fermi"}],"status":"idle","statusTrack":[],"flowchartId":"f9b3f66b-6659-581d-8791-7153c195214f","tags":[],"head":false,"application":{"name":"python","shortName":"py","summary":"Python Script","build":"GNU","isDefault":true,"version":"3.10.13","schemaVersion":"2022.8.16"}}]}
