{
    "_id": "d89c776d-3b76-54d6-9f9a-f9e244b1e9e2",
    "name": "Extract Slab Coordinates",
    "application": {
        "name": "python"
    },
    "properties": [],
    "model": {
        "type": "unknown",
        "subtype": "unknown",
        "method": {
            "type": "unknown",
            "subtype": "unknown",
            "data": {}
        }
    },
    "units": [
        {
            "type": "execution",
            "name": "Extract Z-Coordinates from Material",
            "head": true,
            "results": [],
            "monitors": [
                {
                    "name": "standard_output"
                }
            ],
            "flowchartId": "python-extract-coords",
            "preProcessors": [],
            "postProcessors": [],
            "application": {
                "name": "python",
                "shortName": "py",
                "summary": "Python Script",
                "build": "GNU",
                "isDefault": true,
                "version": "3.10.13",
                "schemaVersion": "2022.8.16"
            },
            "executable": {
                "isDefault": true,
                "monitors": [
                    "standard_output"
                ],
                "name": "python",
                "schemaVersion": "2022.8.16"
            },
            "flavor": {
                "applicationName": "python",
                "executableName": "python",
                "input": [
                    {
                        "name": "extract_slab_coordinates.py",
                        "templateName": "extract_slab_coordinates.py"
                    },
                    {
                        "name": "requirements.txt",
                        "templateName": "requirements_with_made.txt"
                    }
                ],
                "monitors": [
                    "standard_output"
                ],
                "name": "generic:processing:extract_slab_coordinates",
                "schemaVersion": "2022.8.16",
                "isDefault": false
            },
            "status": "idle",
            "statusTrack": [],
            "tags": [],
            "input": [
                {
                    "applicationName": "python",
                    "content": "#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\"\"\"\nExtract z-coordinate boundaries from materials for polar VBO calculation.\n\nReads material data from the job JSON file in the working directory.\nThis is more reliable than reading from pw_scf.out which may be overwritten\nin multi-material workflows.\n\"\"\"\nimport json\nimport os\nimport glob\n\nimport numpy as np\n\n# Material index: 0=Interface, 1=Left, 2=Right\n{% raw %}material_index = int({{material_index}}){% endraw %}\n\n# Find the job JSON file in the current directory\n# It's typically named with the job slug (e.g., \"abc123def.json\")\njson_files = glob.glob(\"*.json\")\njob_file = None\nfor f in json_files:\n    # Skip result files and other known non-job files\n    if f.startswith(\"result\") or f.startswith(\"properties\"):\n        continue\n    # The job file typically has a slug-like name (alphanumeric)\n    basename = os.path.splitext(f)[0]\n    if basename.isalnum() and len(basename) > 10:\n        job_file = f\n        break\n\nif job_file is None:\n    raise FileNotFoundError(\"Cannot find job JSON file in working directory\")\n\n# Read job configuration\nwith open(job_file, 'r') as f:\n    job_data = json.load(f)\n\n# Get materials from job data\n# Materials can be in 'materials' or '_materials' field\nmaterials = job_data.get('materials', job_data.get('_materials', []))\n\nif not materials or material_index >= len(materials):\n    raise ValueError(f\"Material index {material_index} not found. Available: {len(materials)} materials\")\n\nmaterial = materials[material_index]\n\n# Extract basis coordinates\nbasis = material.get('basis', {})\ncoordinates = basis.get('coordinates', [])\nelements = basis.get('elements', [])\n\n# Get z-coordinates (fractional by default)\nz_coords_frac = []\nfor coord in coordinates:\n    value = coord.get('value', [0, 0, 0])\n    z_coords_frac.append(value[2])\n\nz_coords_frac = np.array(z_coords_frac)\n\n# Get lattice c parameter\nlattice = material.get('lattice', {})\nc_length = lattice.get('c', 1.0)\n\n# Check coordinate units\nunits = basis.get('units', 'crystal')\nif units == 'crystal':\n    # Fractional - convert to Angstroms\n    z_coords_angstrom = z_coords_frac * c_length\nelse:\n    # Already in Angstroms\n    z_coords_angstrom = z_coords_frac\n\n# Extract z-range\nz_min = float(np.min(z_coords_angstrom))\nz_max = float(np.max(z_coords_angstrom))\n\nresult = {\n    \"z_min\": z_min,\n    \"z_max\": z_max,\n    \"material_index\": material_index,\n}\n\nprint(json.dumps(result, indent=4))\n",
                    "contextProviders": [],
                    "executableName": "python",
                    "name": "extract_slab_coordinates.py",
                    "rendered": "#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n\"\"\"\nExtract z-coordinate boundaries from materials for polar VBO calculation.\n\nReads material data from the job JSON file in the working directory.\nThis is more reliable than reading from pw_scf.out which may be overwritten\nin multi-material workflows.\n\"\"\"\nimport json\nimport os\nimport glob\n\nimport numpy as np\n\n# Material index: 0=Interface, 1=Left, 2=Right\nmaterial_index = int({{material_index}})\n\n# Find the job JSON file in the current directory\n# It's typically named with the job slug (e.g., \"abc123def.json\")\njson_files = glob.glob(\"*.json\")\njob_file = None\nfor f in json_files:\n    # Skip result files and other known non-job files\n    if f.startswith(\"result\") or f.startswith(\"properties\"):\n        continue\n    # The job file typically has a slug-like name (alphanumeric)\n    basename = os.path.splitext(f)[0]\n    if basename.isalnum() and len(basename) > 10:\n        job_file = f\n        break\n\nif job_file is None:\n    raise FileNotFoundError(\"Cannot find job JSON file in working directory\")\n\n# Read job configuration\nwith open(job_file, 'r') as f:\n    job_data = json.load(f)\n\n# Get materials from job data\n# Materials can be in 'materials' or '_materials' field\nmaterials = job_data.get('materials', job_data.get('_materials', []))\n\nif not materials or material_index >= len(materials):\n    raise ValueError(f\"Material index {material_index} not found. Available: {len(materials)} materials\")\n\nmaterial = materials[material_index]\n\n# Extract basis coordinates\nbasis = material.get('basis', {})\ncoordinates = basis.get('coordinates', [])\nelements = basis.get('elements', [])\n\n# Get z-coordinates (fractional by default)\nz_coords_frac = []\nfor coord in coordinates:\n    value = coord.get('value', [0, 0, 0])\n    z_coords_frac.append(value[2])\n\nz_coords_frac = np.array(z_coords_frac)\n\n# Get lattice c parameter\nlattice = material.get('lattice', {})\nc_length = lattice.get('c', 1.0)\n\n# Check coordinate units\nunits = basis.get('units', 'crystal')\nif units == 'crystal':\n    # Fractional - convert to Angstroms\n    z_coords_angstrom = z_coords_frac * c_length\nelse:\n    # Already in Angstroms\n    z_coords_angstrom = z_coords_frac\n\n# Extract z-range\nz_min = float(np.min(z_coords_angstrom))\nz_max = float(np.max(z_coords_angstrom))\n\nresult = {\n    \"z_min\": z_min,\n    \"z_max\": z_max,\n    \"material_index\": material_index,\n}\n\nprint(json.dumps(result, indent=4))\n",
                    "schemaVersion": "2022.8.16"
                },
                {
                    "applicationName": "python",
                    "content": "# ----------------------------------------------------------------- #\n#                                                                   #\n#  Example Python package requirements for the Mat3ra platform      #\n#                                                                   #\n#  Will be used as follows:                                         #\n#                                                                   #\n#    1. A runtime directory for this calculation is created         #\n#    2. This list is used to populate a Python virtual environment  #\n#    3. The virtual environment is activated                        #\n#    4. The Python process running the script included within this  #\n#       job is started                                              #\n#                                                                   #\n#  For more information visit:                                      #\n#   - https://pip.pypa.io/en/stable/reference/pip_install           #\n#   - https://virtualenv.pypa.io/en/stable/                         #\n#                                                                   #\n# ----------------------------------------------------------------- #\n\n\nmunch==2.5.0\nnumpy>=1.19.5\nscipy>=1.5.4\nmatplotlib>=3.0.0\nmat3ra-made[tools]>=2024.11.12.0\n\n",
                    "contextProviders": [],
                    "executableName": "python",
                    "name": "requirements.txt",
                    "rendered": "# ----------------------------------------------------------------- #\n#                                                                   #\n#  Example Python package requirements for the Mat3ra platform      #\n#                                                                   #\n#  Will be used as follows:                                         #\n#                                                                   #\n#    1. A runtime directory for this calculation is created         #\n#    2. This list is used to populate a Python virtual environment  #\n#    3. The virtual environment is activated                        #\n#    4. The Python process running the script included within this  #\n#       job is started                                              #\n#                                                                   #\n#  For more information visit:                                      #\n#   - https://pip.pypa.io/en/stable/reference/pip_install           #\n#   - https://virtualenv.pypa.io/en/stable/                         #\n#                                                                   #\n# ----------------------------------------------------------------- #\n\n\nmunch==2.5.0\nnumpy>=1.19.5\nscipy>=1.5.4\nmatplotlib>=3.0.0\nmat3ra-made[tools]>=2024.11.12.0\n\n",
                    "schemaVersion": "2022.8.16"
                }
            ],
            "next": "83a497a3-98ef-56c6-8645-2ed81aea47df"
        },
        {
            "name": "Parse Coordinate Results",
            "type": "assignment",
            "operand": "COORDS",
            "value": "json.loads(STDOUT)",
            "input": [
                {
                    "name": "STDOUT",
                    "scope": "python-extract-coords"
                }
            ],
            "status": "idle",
            "statusTrack": [],
            "flowchartId": "83a497a3-98ef-56c6-8645-2ed81aea47df",
            "tags": [],
            "head": false,
            "next": "09fad237-1902-5932-a600-7eadd7f3553d",
            "application": {
                "name": "python",
                "shortName": "py",
                "summary": "Python Script",
                "build": "GNU",
                "isDefault": true,
                "version": "3.10.13",
                "schemaVersion": "2022.8.16"
            }
        },
        {
            "name": "Set Z Min Coordinate",
            "type": "assignment",
            "operand": "z_min",
            "value": "COORDS['z_min']",
            "input": [],
            "status": "idle",
            "statusTrack": [],
            "flowchartId": "09fad237-1902-5932-a600-7eadd7f3553d",
            "tags": [],
            "head": false,
            "next": "f10d39b6-dc04-5874-af8c-a7d9c7d9d466",
            "application": {
                "name": "python",
                "shortName": "py",
                "summary": "Python Script",
                "build": "GNU",
                "isDefault": true,
                "version": "3.10.13",
                "schemaVersion": "2022.8.16"
            }
        },
        {
            "name": "Set Z Max Coordinate",
            "type": "assignment",
            "operand": "z_max",
            "value": "COORDS['z_max']",
            "input": [],
            "status": "idle",
            "statusTrack": [],
            "flowchartId": "f10d39b6-dc04-5874-af8c-a7d9c7d9d466",
            "tags": [],
            "head": false,
            "application": {
                "name": "python",
                "shortName": "py",
                "summary": "Python Script",
                "build": "GNU",
                "isDefault": true,
                "version": "3.10.13",
                "schemaVersion": "2022.8.16"
            }
        }
    ]
}
