{"_id":"1bb75a6a-4c8c-5336-a24c-1963e83825bc","name":"Extract Bands Near Fermi","application":{"name":"espresso"},"properties":[],"model":{"type":"unknown","subtype":"unknown","method":{"type":"unknown","subtype":"unknown","data":{}}},"units":[{"type":"execution","name":"extract_bands_fermi","head":true,"results":[],"monitors":[{"name":"standard_output"}],"flowchartId":"extract-band-fermi","preProcessors":[],"postProcessors":[],"application":{"name":"python","shortName":"py","summary":"Python Script","build":"GNU","isDefault":true,"version":"3.10.13","schemaVersion":"2022.8.16"},"executable":{"isDefault":true,"monitors":["standard_output"],"name":"python","schemaVersion":"2022.8.16"},"flavor":{"applicationName":"python","executableName":"python","input":[{"name":"extract_bands_fermi.py"},{"name":"requirements.txt","templateName":"requirements_bands_fermi.txt"}],"monitors":["standard_output"],"name":"extract_bands_fermi","schemaVersion":"2022.8.16","isDefault":false},"status":"idle","statusTrack":[],"tags":[],"input":[{"applicationName":"python","content":"# ---------------------------------------------------------------- #\n# Extract band indices near Fermi energy from band_structure       #\n# This script expects fermi_energy and band_structure results      #\n# ---------------------------------------------------------------- #\nimport json\nfrom munch import Munch\n\n# Data From Context\n# -----------------\n# fermi_energy: float (in eV) - from pw_scf result\n# band_structure: Munch object with band energies - from pw_bands result\n\n{% raw %}fermi_energy_value = {{ fermi_energy }}{% endraw %}\n{% raw %}band_structure_data = {{ band_structure }}{% endraw %}\n\n# Extract band energies at Gamma point (first k-point)\n# band_structure format from QE parser:\n# {\n#   \"name\": \"band_structure\",\n#   \"xDataArray\": [[kx, ky, kz], ...],  # k-points\n#   \"yDataSeries\": [[e1_k1, e1_k2, ...], [e2_k1, e2_k2, ...], ...]  # energies per band\n# }\n# yDataSeries[band_index][kpoint_index] = energy\n\n# Get energies at first k-point (Gamma, index 0) for all bands\ny_data = band_structure_data.get('yDataSeries', [])\nband_energies = [band_data[0] for band_data in y_data] if y_data else []\n\n# Find bands near Fermi energy (1-based indices as QE expects)\nvalence_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e <= fermi_energy_value]\nconduction_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e > fermi_energy_value]\n\nif valence_bands:\n    valence_index, valence_energy = max(valence_bands, key=lambda x: x[1])\nelse:\n    valence_index = 1\n    valence_energy = band_energies[0] if band_energies else 0.0\n\nif conduction_bands:\n    conduction_index, conduction_energy = min(conduction_bands, key=lambda x: x[1])\nelse:\n    conduction_index = len(band_energies)\n    conduction_energy = band_energies[-1] if band_energies else 0.0\n\nresult = {\n    \"band_below_fermi\": valence_index,\n    \"band_above_fermi\": conduction_index,\n    \"fermi_energy\": fermi_energy_value,\n    \"valence_energy\": valence_energy,\n    \"conduction_energy\": conduction_energy,\n    \"total_bands\": len(band_energies)\n}\n\n# Print to STDOUT for subsequent assignment unit\nprint(json.dumps(result, indent=4))\n","contextProviders":[],"executableName":"python","name":"extract_bands_fermi.py","rendered":"# ---------------------------------------------------------------- #\n# Extract band indices near Fermi energy from band_structure       #\n# This script expects fermi_energy and band_structure results      #\n# ---------------------------------------------------------------- #\nimport json\nfrom munch import Munch\n\n# Data From Context\n# -----------------\n# fermi_energy: float (in eV) - from pw_scf result\n# band_structure: Munch object with band energies - from pw_bands result\n\nfermi_energy_value = {{ fermi_energy }}\nband_structure_data = {{ band_structure }}\n\n# Extract band energies at Gamma point (first k-point)\n# band_structure format from QE parser:\n# {\n#   \"name\": \"band_structure\",\n#   \"xDataArray\": [[kx, ky, kz], ...],  # k-points\n#   \"yDataSeries\": [[e1_k1, e1_k2, ...], [e2_k1, e2_k2, ...], ...]  # energies per band\n# }\n# yDataSeries[band_index][kpoint_index] = energy\n\n# Get energies at first k-point (Gamma, index 0) for all bands\ny_data = band_structure_data.get('yDataSeries', [])\nband_energies = [band_data[0] for band_data in y_data] if y_data else []\n\n# Find bands near Fermi energy (1-based indices as QE expects)\nvalence_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e <= fermi_energy_value]\nconduction_bands = [(i + 1, e) for i, e in enumerate(band_energies) if e > fermi_energy_value]\n\nif valence_bands:\n    valence_index, valence_energy = max(valence_bands, key=lambda x: x[1])\nelse:\n    valence_index = 1\n    valence_energy = band_energies[0] if band_energies else 0.0\n\nif conduction_bands:\n    conduction_index, conduction_energy = min(conduction_bands, key=lambda x: x[1])\nelse:\n    conduction_index = len(band_energies)\n    conduction_energy = band_energies[-1] if band_energies else 0.0\n\nresult = {\n    \"band_below_fermi\": valence_index,\n    \"band_above_fermi\": conduction_index,\n    \"fermi_energy\": fermi_energy_value,\n    \"valence_energy\": valence_energy,\n    \"conduction_energy\": conduction_energy,\n    \"total_bands\": len(band_energies)\n}\n\n# Print to STDOUT for subsequent assignment unit\nprint(json.dumps(result, indent=4))\n","schemaVersion":"2022.8.16"},{"applicationName":"python","content":"input_files_templates/python/espresso/requirements_bands_fermi.j2.txt","contextProviders":[],"executableName":"python","name":"requirements.txt","rendered":"input_files_templates/python/espresso/requirements_bands_fermi.j2.txt","schemaVersion":"2022.8.16"}],"next":"f9b3f66b-6659-581d-8791-7153c195214f"},{"name":"Store Band Number","type":"assignment","operand":"KBAND_VALUE","value":"json.loads(STDOUT)['band_below_fermi']","input":[{"name":"STDOUT","scope":"extract-band-fermi"}],"status":"idle","statusTrack":[],"flowchartId":"f9b3f66b-6659-581d-8791-7153c195214f","tags":[],"head":false,"application":{"name":"python","shortName":"py","summary":"Python Script","build":"GNU","isDefault":true,"version":"3.10.13","schemaVersion":"2022.8.16"}}]}
