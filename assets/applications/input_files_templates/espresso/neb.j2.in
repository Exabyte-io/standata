BEGIN
BEGIN_PATH_INPUT
&PATH
  restart_mode      = 'from_scratch'
  string_method     = 'neb',
  nstep_path        = 50,
  ds                = 2.D0,
  opt_scheme        = "broyden",
  num_of_images     = {{ 2 + (input.INTERMEDIATE_IMAGES.length or neb.nImages) }},
  k_max             = 0.3D0,
  k_min             = 0.2D0,
  CI_scheme         = "auto",
  path_thr          = 0.1D0,
/
END_PATH_INPUT
BEGIN_ENGINE_INPUT
&CONTROL
    prefix = '__prefix__'
    outdir = {% raw %}'{{ JOB_WORK_DIR }}/outdir'{% endraw %}
    pseudo_dir = {% raw %}'{{ JOB_WORK_DIR }}/pseudo'{% endraw %}
/
&SYSTEM
    ibrav = {{ input.IBRAV }}
    nat = {{ input.NAT }}
    ntyp = {{ input.NTYP }}
    ecutwfc = {{ cutoffs.wavefunction }}
    ecutrho = {{ cutoffs.density }}
    occupations = 'smearing'
    degauss = 0.03
    nspin = 2
    starting_magnetization = 0.5
/
&ELECTRONS
    conv_thr    = 1.D-8
    mixing_beta = 0.3
/
ATOMIC_SPECIES
{% for specie in input.ATOMIC_SPECIES -%}
{{ specie.X }} {{ specie.Mass_X|sprintf("%f") }} {{ specie.PseudoPot_X }}
{% endfor %}
BEGIN_POSITIONS
FIRST_IMAGE
ATOMIC_POSITIONS crystal
{%- set print_constraints_first = false %}
{%- for position in input.FIRST_IMAGE %}
    {%- if position["if_pos(1)"] != 1 or position["if_pos(2)"] != 1 or position["if_pos(3)"] != 1 %}
        {%- set print_constraints_first = true %}
    {%- endif %}
{%- endfor %}
{% for position in input.FIRST_IMAGE -%}
{{ position.X|sprintf("%-3s") }} {{ position.x|sprintf("%14.9f") }} {{ position.y|sprintf("%14.9f") }} {{ position.z|sprintf("%14.9f") }}{% if print_constraints_first %} {{ position["if_pos(1)"] }} {{ position["if_pos(2)"] }} {{ position["if_pos(3)"] }}{% endif %}
{% endfor %}
{%- for IMAGE in input.INTERMEDIATE_IMAGES %}
INTERMEDIATE_IMAGE
ATOMIC_POSITIONS crystal
{%- set print_constraints_intermediate = false %}
{%- for position in IMAGE %}
    {%- if position["if_pos(1)"] != 1 or position["if_pos(2)"] != 1 or position["if_pos(3)"] != 1 %}
        {%- set print_constraints_intermediate = true %}
    {%- endif %}
{%- endfor %}
{% for position in IMAGE -%}
{{ position.X|sprintf("%-3s") }} {{ position.x|sprintf("%14.9f") }} {{ position.y|sprintf("%14.9f") }} {{ position.z|sprintf("%14.9f") }}{% if print_constraints_intermediate %} {{ position["if_pos(1)"] }} {{ position["if_pos(2)"] }} {{ position["if_pos(3)"] }}{% endif %}
{% endfor %}
{%- endfor %}
LAST_IMAGE
ATOMIC_POSITIONS crystal
{%- set print_constraints_last = false %}
{%- for position in input.LAST_IMAGE %}
    {%- if position["if_pos(1)"] != 1 or position["if_pos(2)"] != 1 or position["if_pos(3)"] != 1 %}
        {%- set print_constraints_last = true %}
    {%- endif %}
{%- endfor %}
{% for position in input.LAST_IMAGE -%}
{{ position.X|sprintf("%-3s") }} {{ position.x|sprintf("%14.9f") }} {{ position.y|sprintf("%14.9f") }} {{ position.z|sprintf("%14.9f") }}{% if print_constraints_last %} {{ position["if_pos(1)"] }} {{ position["if_pos(2)"] }} {{ position["if_pos(3)"] }}{% endif %}
{% endfor %}
END_POSITIONS
CELL_PARAMETERS angstrom
{{ input.CELL_PARAMETERS.v1[0]|sprintf("%14.9f") }} {{ input.CELL_PARAMETERS.v1[1]|sprintf("%14.9f") }} {{ input.CELL_PARAMETERS.v1[2]|sprintf("%14.9f") }}
{{ input.CELL_PARAMETERS.v2[0]|sprintf("%14.9f") }} {{ input.CELL_PARAMETERS.v2[1]|sprintf("%14.9f") }} {{ input.CELL_PARAMETERS.v2[2]|sprintf("%14.9f") }}
{{ input.CELL_PARAMETERS.v3[0]|sprintf("%14.9f") }} {{ input.CELL_PARAMETERS.v3[1]|sprintf("%14.9f") }} {{ input.CELL_PARAMETERS.v3[2]|sprintf("%14.9f") }}
K_POINTS automatic
{% for d in kgrid.dimensions %}{{d}} {% endfor %}{% for s in kgrid.shifts %}{{s}} {% endfor %}
END_ENGINE_INPUT
END
